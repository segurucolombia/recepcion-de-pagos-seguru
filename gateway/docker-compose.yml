version: '3.8'

services:
  # Servicio del Gateway (tu aplicación Spring Boot)
  gateway:
    # Nombre del contenedor
    container_name: gateway-transacciones-wompi

    # Cargar variables de entorno desde archivo .env
    env_file:
      - .env

    # Construir desde el Dockerfile local
    build:
      context: .
      dockerfile: Dockerfile

    # Nombre de la imagen resultante
    image: gateway-transacciones-wompi:latest

    # Puerto: HOST:CONTAINER
    ports:
      - "3001:3001"

    # Variables de entorno
    environment:
      # Puerto del servidor
      - SERVER_PORT=${SERVER_PORT}

      # URLs de APIs externas - desde .env
      - EXTERNAL_API_RESERVAS_SEGURU=${EXTERNAL_API_RESERVAS_SEGURU}
      - EXTERNAL_API_ALIADOS_SEGURU=${EXTERNAL_API_ALIADOS_SEGURU}

    # Reiniciar automáticamente si falla
    restart: unless-stopped

    # Conectar a una red personalizada
    networks:
      - gateway-network

    # IMPORTANTE: Agregar extra_hosts para resolver host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Red personalizada
networks:
  gateway-network:
    driver: bridge